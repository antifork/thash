typedef unsigned long int u32;

u32
hash (const char *const msg, int len)
{
    static const unsigned char cartab[] = {
	255U, 68U, 69U, 70U, 71U, 72U, 73U, 74U, 75U, 76U, 77U, 78U, 79U, 80U,
	81U, 82U, 83U, 84U, 85U, 86U, 87U, 88U, 89U, 90U, 91U, 92U, 93U, 94U,
	95U, 96U, 97U, 98U, 99U, 100U, 101U, 102U, 103U, 104U, 105U, 65U,
	106U, 107U, 108U, 109U, 110U, 66U, 57U, 111U, 0U, 1U, 2U, 3U, 4U, 5U,
	6U, 7U, 8U, 9U, 112U, 113U, 114U, 115U, 116U, 117U, 118U, 10U, 11U,
	12U, 13U, 14U, 15U, 47U, 45U, 55U, 52U, 51U, 46U, 42U, 53U, 54U, 44U,
	64U, 49U, 41U, 48U, 59U, 56U, 50U, 62U, 58U, 61U, 119U, 120U, 121U,
	122U, 60U, 123U, 19U, 32U, 25U, 26U, 16U, 34U, 28U, 31U, 17U, 43U,
	36U, 24U, 30U, 20U, 23U, 29U, 40U, 21U, 18U, 22U, 27U, 35U, 37U, 39U,
	33U, 38U, 124U, 125U, 126U, 63U, 67U, 128U, 129U, 130U, 131U, 132U,
	133U, 134U, 135U, 136U, 137U, 138U, 139U, 140U, 141U, 142U, 143U,
	144U, 145U, 146U, 147U, 148U, 149U, 150U, 151U, 152U, 153U, 154U,
	155U, 156U, 157U, 158U, 159U, 160U, 161U, 162U, 163U, 164U, 165U,
	166U, 167U, 168U, 169U, 170U, 171U, 172U, 173U, 174U, 175U, 176U,
	177U, 178U, 179U, 180U, 181U, 182U, 183U, 184U, 185U, 186U, 187U,
	188U, 189U, 190U, 191U, 192U, 193U, 194U, 195U, 196U, 197U, 198U,
	199U, 200U, 201U, 202U, 203U, 204U, 205U, 206U, 207U, 208U, 209U,
	210U, 211U, 212U, 213U, 214U, 215U, 216U, 217U, 218U, 219U, 220U,
	221U, 222U, 223U, 224U, 225U, 226U, 227U, 228U, 229U, 230U, 231U,
	232U, 233U, 234U, 235U, 236U, 237U, 238U, 239U, 240U, 241U, 242U,
	243U, 244U, 245U, 246U, 247U, 248U, 249U, 250U, 251U, 252U, 253U,
	254U, 127U
    };
    u32 j;

    if (len == 8) {
	j = (cartab[msg[2]] << 27);
	j ^= (cartab[msg[3]] << 23);
	j ^= (cartab[msg[4]] << 19);
	j ^= (cartab[msg[5]] << 15);
	j ^= (cartab[msg[6]] << 11);
	j ^= (cartab[msg[7]] << 7);
	j ^= (cartab[msg[0]] << 21);
	j ^= (cartab[msg[1]] << 13);

	return j;
    }

    j = (u32) 4851;
    do {
	len--;
	j += (j << 5);
	j ^= ~cartab[msg[len]];
    } while (len != 0);

    return j ^ ((j & 0x7f) << 24);
}
